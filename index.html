<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>名古屋 × 東京｜8 天旅遊小工具</title>
  <meta name="theme-color" content="#f8f2e7" />
  <style>
    :root{
      --bg:#f8f2e7;
      --fg:#2b1d12;
      --muted:#6b5a3e;
      --border:#422615;
      --card: rgba(255,255,255,.35);
      --shadow: 0 10px 28px rgba(66,38,21,.12);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic ProN", "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", system-ui, sans-serif;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:var(--sans);
      background:var(--bg);
      color:var(--fg);
    }
    header{
      position:sticky; top:0;
      background: rgba(255,247,214,.92);
      backdrop-filter: blur(10px);
      border-bottom: 2px solid var(--border);
      z-index:10;
    }
    .topbar{ max-width:560px; margin:0 auto; padding:14px 14px 10px; }
    .title{ font-size:16px; font-weight:800; letter-spacing:.2px; }
    .subtitle{ margin-top:4px; font-size:12px; color:var(--muted); line-height:1.4; }
    .tabs{
      display:flex; gap:8px; padding: 10px 14px 12px; overflow:auto;
      max-width:560px; margin:0 auto;
      border-top: 1px solid rgba(66,38,21,.35);
    }
    .tab{
      padding:8px 12px; border:1.5px solid var(--border);
      border-radius:999px; font-size:12px; background:transparent; color:var(--fg);
      white-space:nowrap;
    }
    .tab.active{ background:var(--border); color:var(--bg); }

    .app{ max-width:560px; margin:0 auto; padding:14px 14px 92px; }
    .panel{ display:none; }
    .panel.active{ display:block; }

    .daystrip{ display:flex; gap:8px; overflow:auto; padding-bottom:10px; }
    .daybtn{
      min-width:86px; padding:10px 10px; text-align:left;
      border:1.5px solid var(--border); border-radius:16px;
      background:transparent;
    }
    .daybtn.active{ background: rgba(255,255,255,.25); box-shadow: var(--shadow); }
    .daybtn .d{ font-weight:800; font-size:12px; }
    .daybtn .dt{ font-size:11px; color:var(--muted); margin-top:2px; }
    .hero{
      border:1.5px solid var(--border); border-radius: var(--radius);
      padding:12px; background: var(--card); box-shadow: var(--shadow);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .hero h2{ margin:0; font-size:14px; }
    .hero .meta{ margin-top:6px; color:var(--muted); font-size:12px; line-height:1.45; }
    .weather{ text-align:right; min-width:140px; }
    .weather .w1{ font-weight:800; font-size:12px; }
    .weather .w2{ margin-top:2px; font-size:11px; color:var(--muted); }

    .cards{ margin-top:12px; display:flex; flex-direction:column; gap:10px; }
    .card{
      border:1.5px solid var(--border); border-radius: var(--radius);
      padding:12px; background: var(--card); box-shadow: var(--shadow);
    }
    .row1{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .time{ font-family:var(--mono); font-size:12px; color:var(--muted); }
    .type{
      font-size:11px; padding:4px 10px; border-radius:999px;
      border:1px solid rgba(66,38,21,.55);
      background: rgba(255,255,255,.25);
      white-space:nowrap;
    }
    .title2{ margin:8px 0 0; font-size:14px; font-weight:800; line-height:1.35; }
    .note{ margin-top:6px; font-size:12px; color:var(--muted); line-height:1.45; }
    .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:10px; }
    .chip{
      font-size:11px; padding:4px 10px; border-radius:999px;
      border:1px solid rgba(66,38,21,.65);
      background: rgba(255,255,255,.25);
    }
    .chip.must{ font-weight:800; }
    .chip.warn{ font-weight:800; text-decoration: underline; text-decoration-thickness:2px; }
    .chip.buy{ font-weight:800; }

    .actions{ display:flex; gap:8px; margin-top:12px; }
    .btn{
      flex:1; padding:10px 10px; border-radius:14px;
      border:1.5px solid var(--border); background:transparent;
      font-size:12px; text-decoration:none; color:var(--fg);
      text-align:center;
    }
    .btn.primary{ background: var(--border); color: var(--bg); }

    .sectionTitle{ font-size:13px; font-weight:900; margin: 4px 0 10px; }

    .item{
      border:1.5px solid var(--border); border-radius: var(--radius);
      padding:12px; background: var(--card); box-shadow: var(--shadow);
      margin-bottom:10px;
    }
    .item .h{ font-weight:900; font-size:13px; }
    .item .p{ margin-top:6px; color:var(--muted); font-size:12px; line-height:1.45; }

    /* Modal detail sheet */
    .sheetBack{
      position:fixed; left:0; right:0; top:0; bottom:0;
      background: rgba(0,0,0,.35);
      display:none; align-items:flex-end; justify-content:center;
      z-index:99;
      padding: 10px 10px 18px;
    }
    .sheet{
      width: min(560px, 100%);
      background: var(--bg);
      border:2px solid var(--border);
      border-radius: 22px;
      box-shadow: 0 18px 60px rgba(0,0,0,.22);
      max-height: 85vh;
      overflow:auto;
    }
    .sheetHeader{
      position:sticky; top:0;
      background: rgba(255,247,214,.96);
      border-bottom:1px solid rgba(66,38,21,.35);
      padding: 12px 12px 10px;
      border-top-left-radius: 20px; border-top-right-radius: 20px;
    }
    .sheetHeader .x{
      float:right; border:1.5px solid var(--border);
      border-radius: 12px; padding:6px 10px; background:transparent;
      font-size:12px;
    }
    .sheetTitle{ font-weight:900; font-size:15px; margin:0; }
    .sheetSub{ margin-top:4px; color:var(--muted); font-size:12px; line-height:1.45; }
    .sheetBody{ padding: 12px; }
    .block{ border:1.5px solid rgba(66,38,21,.45); border-radius:16px; padding:12px; background: rgba(255,255,255,.20); margin-bottom:10px; }
    .block .k{ font-weight:900; font-size:12px; margin-bottom:6px; }
    .block .v{ color:var(--muted); font-size:12px; line-height:1.55; }
    .block ul{ margin:6px 0 0; padding-left:18px; }
    .block li{ margin:4px 0; }
    .small{ font-size:11px; color:var(--muted); }

    /* Budget */
    .budgetForm{ display:flex; gap:8px; flex-wrap:wrap; }
    select,input{
      font-family:var(--sans); font-size:12px;
      padding:10px; border-radius:14px;
      border:1.5px solid var(--border);
      background: rgba(255,255,255,.25);
      color: var(--fg);
    }
    input[type="number"]{ width:120px; }
    input[type="text"]{ flex:1; min-width:160px; }
    .budgetTable{ width:100%; border-collapse:separate; border-spacing:0 8px; margin-top:12px; }
    .budgetTable th{ text-align:left; font-size:11px; color:var(--muted); font-weight:800; }
    .budgetTable td{ background: rgba(255,255,255,.25); border:1.5px solid var(--border); padding:10px; border-radius:14px; font-size:12px; }

    .footerbar{
      position:fixed; left:0; right:0; bottom:0;
      background: rgba(255,247,214,.92);
      backdrop-filter: blur(10px);
      border-top:2px solid var(--border);
      z-index:10;
    }
    .footerbar .inner{
      max-width:560px; margin:0 auto; padding:10px 14px; display:flex; gap:8px;
    }
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="title" id="appTitle">名古屋 × 東京｜8 天旅遊小工具</div>
    <div class="subtitle" id="appSub">單頁 App｜卡片可點進去看詳細介紹｜天氣需連網</div>
  </div>
  <div class="tabs" id="tabs"></div>
</header>

<div class="app">
  <div class="panel active" id="panel-itinerary">
    <div class="daystrip" id="daystrip"></div>
    <div class="hero">
      <div>
        <h2 id="dayHeading">Day</h2>
        <div class="meta" id="dayMeta"></div>
      </div>
      <div class="weather">
        <div class="w1" id="w1">天氣載入中</div>
        <div class="w2" id="w2"></div>
      </div>
    </div>
    <div class="cards" id="cards"></div>
  </div>

  <div class="panel" id="panel-flights">
    <div class="sectionTitle">航班資訊</div>
    <div id="flightsList"></div>
  </div>

  <div class="panel" id="panel-lodging">
    <div class="sectionTitle">住宿資訊</div>
    <div id="lodgingList"></div>
  </div>

  <div class="panel" id="panel-emergency">
    <div class="sectionTitle">緊急聯絡</div>
    <div id="emergencyList"></div>
    <div class="small" style="margin-top:10px;">提示：可在 itinerary.json 補上保險/信用卡掛失專線與代號。</div>
  </div>

  <div class="panel" id="panel-budget">
    <div class="sectionTitle">記帳 / 預算</div>
    <div class="item">
      <div class="p">快速新增一筆支出（儲存在本機 localStorage）。</div>
      <div class="budgetForm" style="margin-top:10px;">
        <select id="bCat"></select>
        <input id="bAmt" type="number" inputmode="decimal" placeholder="JPY" />
        <input id="bNote" type="text" placeholder="備註（如：bills hotcakes）" />
        <button class="btn primary" id="bAdd" style="flex:0 0 auto;">新增</button>
      </div>
    </div>
    <div class="item">
      <div class="row1">
        <div class="h">本次紀錄</div>
        <button class="btn" id="bExport" style="flex:0 0 auto;">匯出 CSV</button>
      </div>
      <table class="budgetTable" id="bTable">
        <thead>
          <tr><th>日期</th><th>分類</th><th>金額</th><th>備註</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="small" id="bSum"></div>
    </div>
  </div>
</div>

<div class="footerbar">
  <div class="inner">
    <a class="btn" href="#itinerary" data-tab="itinerary">行程</a>
    <a class="btn" href="#flights" data-tab="flights">航班</a>
    <a class="btn" href="#lodging" data-tab="lodging">住宿</a>
    <a class="btn" href="#emergency" data-tab="emergency">緊急</a>
    <a class="btn" href="#budget" data-tab="budget">預算</a>
  </div>
</div>

<!-- Detail Sheet -->
<div class="sheetBack" id="sheetBack" role="dialog" aria-modal="true">
  <div class="sheet" id="sheet">
    <div class="sheetHeader">
      <button class="x" onclick="closeSheet()">關閉</button>
      <div class="sheetTitle" id="sheetTitle"></div>
      <div class="sheetSub" id="sheetSub"></div>
    </div>
    <div class="sheetBody" id="sheetBody"></div>
  </div>
</div>

<script>
const TYPE_LABEL = { food:"餐廳", spot:"景點/購物", transport:"交通", lodging:"住宿", info:"資訊" };
const PANEL_IDS = ["itinerary","flights","lodging","emergency","budget"];

function $(id){ return document.getElementById(id); }
function esc(s){ return (s??"").toString().replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }

function mapsSearchUrl(q){
  const u = new URL("https://www.google.com/maps/search/");
  u.searchParams.set("api","1");
  u.searchParams.set("query", q);
  return u.toString();
}
function mapsDirUrl(q){
  const u = new URL("https://www.google.com/maps/dir/");
  u.searchParams.set("api","1");
  u.searchParams.set("destination", q);
  return u.toString();
}
function googleOfficialSearch(title){
  const q = `${title} 公式サイト`;
  const u = new URL("https://www.google.com/search");
  u.searchParams.set("q", q);
  return u.toString();
}

function chipHtml(text, kind=""){
  const cls = ["chip"];
  if(kind) cls.push(kind);
  return `<span class="${cls.join(" ")}">${esc(text)}</span>`;
}

function cardTypeText(t){
  return TYPE_LABEL[t] || "項目";
}

function renderCards(day){
  const container = $("cards");
  container.innerHTML = "";
  day.cards.forEach((c, idx)=>{
    let t = c.type;
    if((c.tags||[]).includes("住宿")) t = "lodging";

    const chips = [];
    (c.tags||[]).forEach(x=>{
      if(x.includes("風險") || x==="偏趕") chips.push(chipHtml(x,"warn"));
      else if(x.includes("必吃") || x.includes("必看") || x==="必拍") chips.push(chipHtml(x,"must"));
      else if(x.includes("必買")) chips.push(chipHtml(x,"buy"));
      else chips.push(chipHtml(x,""));
    });
    (c.mustEat||[]).forEach(x=>chips.push(chipHtml("必吃："+x,"must")));
    (c.mustOrder||[]).forEach(x=>chips.push(chipHtml("必點："+x,"must")));
    (c.mustBuy||[]).forEach(x=>chips.push(chipHtml("必買："+x,"buy")));

    const addr = c.address || c.title;

    const html = `
      <div class="card">
        <div class="row1">
          <div class="time">${esc(c.time)}</div>
          <div class="type">${esc(cardTypeText(t))}</div>
        </div>
        <div class="title2">${esc(c.title)}</div>
        ${c.note ? `<div class="note">${esc(c.note)}</div>` : ``}
        ${chips.length ? `<div class="chips">${chips.join("")}</div>` : ``}
        <div class="actions">
          <button class="btn primary" onclick="openSheet(${window.STATE.dayIndex}, ${idx})">詳細</button>
          <a class="btn" href="${mapsDirUrl(addr)}" target="_blank" rel="noopener">導航</a>
          <a class="btn" href="${mapsSearchUrl(addr)}" target="_blank" rel="noopener">地圖</a>
        </div>
      </div>
    `;
    container.insertAdjacentHTML("beforeend", html);
  });
}

function setActiveDay(idx){
  const day = window.APP.days[idx];
  window.STATE.dayIndex = idx;

  document.querySelectorAll(".daybtn").forEach((b,i)=> b.classList.toggle("active", i===idx));
  $("dayHeading").textContent = `${day.dayTitle}｜${day.date}｜${day.baseLocation}`;

  const count = day.cards.length;
  const risk = day.cards.filter(x=>(x.tags||[]).some(t=>t.includes("風險")||t==="偏趕")).length;
  const must = day.cards.filter(x=>(x.tags||[]).some(t=>t.includes("必")) || (x.mustEat||[]).length || (x.mustBuy||[]).length || (x.mustOrder||[]).length).length;
  $("dayMeta").innerHTML = `${esc(day.guideRating||"")}<br>${esc(day.guideToday||"")}<br><span class="small">卡片：${count}｜重點：${must}｜風險：${risk}</span>`;

  renderCards(day);
  loadWeather(day.weather || null, day.baseLocation);
}

function renderDayStrip(){
  const strip = $("daystrip");
  strip.innerHTML = "";
  window.APP.days.forEach((d,i)=>{
    const dt = d.date.slice(5);
    const html = `
      <button class="daybtn" data-i="${i}">
        <div class="d">${esc(d.dayTitle)}</div>
        <div class="dt">${esc(dt)} ${esc(d.baseLocation)}</div>
      </button>
    `;
    strip.insertAdjacentHTML("beforeend", html);
  });
  strip.querySelectorAll(".daybtn").forEach(b=>{
    b.addEventListener("click", ()=> setActiveDay(parseInt(b.dataset.i,10)));
  });
}

/* Weather (lat/lon) */
const WMO = {
  0:"晴",1:"大致晴",2:"局部多雲",3:"多雲",
  45:"霧",48:"霧凍",
  51:"毛毛雨",53:"小雨",55:"中雨",
  61:"小雨",63:"中雨",65:"大雨",
  71:"小雪",73:"中雪",75:"大雪",
  80:"陣雨",81:"強陣雨",82:"暴雨",
  95:"雷雨"
};

let weatherToken = 0;
async function loadWeather(w, fallbackLabel){
  const myToken = ++weatherToken;
  $("w1").textContent = "天氣載入中";
  $("w2").textContent = (w && w.label) ? w.label : fallbackLabel;

  if(!w || !w.lat || !w.lon){
    $("w1").textContent = "天氣未設定";
    $("w2").textContent = "（可在 itinerary.json 補上座標）";
    return;
  }
  try{
    const url = new URL("https://api.open-meteo.com/v1/forecast");
    url.searchParams.set("latitude", w.lat);
    url.searchParams.set("longitude", w.lon);
    url.searchParams.set("current", "temperature_2m,weather_code,wind_speed_10m");
    url.searchParams.set("timezone", "auto");
    const r = await fetch(url);
    if(!r.ok) throw new Error("weather failed");
    const j = await r.json();
    if(myToken !== weatherToken) return;
    const cur = j.current;
    const desc = WMO[cur.weather_code] || ("代碼 " + cur.weather_code);
    $("w1").textContent = `${Math.round(cur.temperature_2m)}°C｜${desc}`;
    $("w2").textContent = `${(w.label||fallbackLabel)}｜風 ${Math.round(cur.wind_speed_10m)} km/h`;
  }catch(e){
    if(myToken !== weatherToken) return;
    $("w1").textContent = "天氣無法載入";
    $("w2").textContent = "（請確認網路/內容阻擋）";
  }
}

/* Detail sheet */
function openSheet(dayIndex, cardIndex){
  const day = window.APP.days[dayIndex];
  const c = day.cards[cardIndex];
  $("sheetTitle").textContent = c.title;

  const addr = c.address || c.title;
  const typeText = cardTypeText(c.type);
  const meta = `${day.dayTitle}｜${day.date}｜${typeText}｜${c.time}`;
  $("sheetSub").textContent = meta;

  const d = c.detail || {};
  const blocks = [];

  if(d.desc){
    blocks.push(block("簡介", `<div class="v">${esc(d.desc)}</div>`));
  }
  if(d.story){
    blocks.push(block("小故事", `<div class="v">${esc(d.story)}</div>`));
  }
  if(d.duration || d.queue){
    const parts = [];
    if(d.duration) parts.push(`<div class="v">停留：${esc(d.duration)}</div>`);
    if(d.queue) parts.push(`<div class="v">排隊：${esc(d.queue)}</div>`);
    blocks.push(block("節奏與排隊", parts.join("")));
  }
  if((c.mustEat||[]).length || (c.mustOrder||[]).length || (c.mustBuy||[]).length || (d.menu||[]).length || (d.souvenirs||[]).length){
    const ul = [];
    (c.mustEat||[]).forEach(x=>ul.push(`<li><b>必吃</b>：${esc(x)}</li>`));
    (c.mustOrder||[]).forEach(x=>ul.push(`<li><b>必點</b>：${esc(x)}</li>`));
    (c.mustBuy||[]).forEach(x=>ul.push(`<li><b>必買</b>：${esc(x)}</li>`));
    (d.menu||[]).forEach(x=>ul.push(`<li>推薦：${esc(x)}</li>`));
    (d.souvenirs||[]).forEach(x=>ul.push(`<li>伴手禮：${esc(x)}</li>`));
    blocks.push(block("必吃 / 必點 / 必買", `<div class="v"><ul>${ul.join("")}</ul></div>`));
  }
  if((d.tips||[]).length){
    const ul = d.tips.map(x=>`<li>${esc(x)}</li>`).join("");
    blocks.push(block("導遊提醒", `<div class="v"><ul>${ul}</ul></div>`));
  }
  if(d.reservations){
    blocks.push(block("預約 / 代碼", `<div class="v">${esc(d.reservations)}</div>`));
  }

  // Links
  const official = c.officialLink || "";
  const linkHtml = `
    <div class="actions" style="margin-top:8px;">
      <a class="btn primary" href="${mapsDirUrl(addr)}" target="_blank" rel="noopener">導航</a>
      <a class="btn" href="${mapsSearchUrl(addr)}" target="_blank" rel="noopener">地圖</a>
      ${official ? `<a class="btn" href="${official}" target="_blank" rel="noopener">官方連結</a>` : `<a class="btn" href="${googleOfficialSearch(c.title)}" target="_blank" rel="noopener">搜尋官網</a>`}
    </div>
    ${official ? `` : `<div class="small" style="margin-top:8px;">此卡片尚未填入官方連結；已提供「搜尋官網」一鍵入口。你可在 itinerary.json 補上 officialLink 後會自動變成「官方連結」。</div>`}
  `;
  blocks.push(block("連結", linkHtml));

  $("sheetBody").innerHTML = blocks.join("");
  $("sheetBack").style.display = "flex";
}
function block(k, inner){
  return `<div class="block"><div class="k">${esc(k)}</div>${inner}</div>`;
}
function closeSheet(){
  $("sheetBack").style.display = "none";
}
$("sheetBack").addEventListener("click", (e)=>{
  if(e.target.id === "sheetBack") closeSheet();
});

/* Tabs */
function mountTabs(){
  const tabs = $("tabs");
  tabs.innerHTML = "";
  const defs = [
    {id:"itinerary", label:"行程"},
    {id:"flights", label:"航班"},
    {id:"lodging", label:"住宿"},
    {id:"emergency", label:"緊急"},
    {id:"budget", label:"預算"},
  ];
  defs.forEach(d=>{
    const b = document.createElement("button");
    b.className = "tab";
    b.textContent = d.label;
    b.dataset.tab = d.id;
    b.addEventListener("click", ()=> setTab(d.id));
    tabs.appendChild(b);
  });
}
function setTab(tab){
  window.STATE.tab = tab;
  document.querySelectorAll(".tab").forEach(b=> b.classList.toggle("active", b.dataset.tab===tab));
  PANEL_IDS.forEach(id=>{
    const p = document.getElementById("panel-"+id);
    if(p) p.classList.toggle("active", id===tab);
  });
  location.hash = tab;
}

/* Lists */
function renderFlights(){
  const box = $("flightsList");
  box.innerHTML = "";
  window.APP.flights.forEach(f=>{
    box.insertAdjacentHTML("beforeend", `
      <div class="item">
        <div class="h">${esc(f.segment)}｜${esc(f.flightNo)}｜${esc(f.date)}</div>
        <div class="p">${esc(f.from)} → ${esc(f.to)}　${esc(f.dep)} – ${esc(f.arr)}${f.pnr?`<br>PNR：<span style="font-family:var(--mono)">${esc(f.pnr)}</span>`:""}</div>
      </div>
    `);
  });
}
function renderLodging(){
  const box = $("lodgingList");
  box.innerHTML = "";
  window.APP.lodging.forEach(l=>{
    box.insertAdjacentHTML("beforeend", `
      <div class="item">
        <div class="h">${esc(l.city)}｜${esc(l.name)}</div>
        <div class="p">${esc(l.address)}${l.bookingCode?`<br>訂房代號：<span style="font-family:var(--mono)">${esc(l.bookingCode)}</span>`:""}</div>
        <div class="actions">
          <a class="btn primary" href="${mapsDirUrl(l.address || l.name)}" target="_blank" rel="noopener">導航</a>
          ${l.officialLink?`<a class="btn" href="${l.officialLink}" target="_blank" rel="noopener">官方連結</a>`:`<span style="flex:1"></span>`}
        </div>
      </div>
    `);
  });
}
function renderEmergency(){
  const box = $("emergencyList");
  box.innerHTML = "";
  window.APP.emergency.forEach(e=>{
    box.insertAdjacentHTML("beforeend", `
      <div class="item">
        <div class="h">${esc(e.label)}</div>
        <div class="p" style="font-family:var(--mono)">${esc(e.value)}</div>
      </div>
    `);
  });
}

/* Budget */
const BKEY = "nagoya_tokyo_budget_v2";
function loadBudget(){
  try{ return JSON.parse(localStorage.getItem(BKEY) || "[]"); }catch{ return []; }
}
function saveBudget(items){ localStorage.setItem(BKEY, JSON.stringify(items)); }
function renderBudget(){
  const items = loadBudget();
  const tbody = document.querySelector("#bTable tbody");
  tbody.innerHTML = "";
  let sum = 0;
  items.forEach((it, idx)=>{
    sum += Number(it.amount||0);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${esc(it.date)}</td>
      <td>${esc(it.category)}</td>
      <td style="font-family:var(--mono)">${esc(it.amount)}</td>
      <td>${esc(it.note||"")}</td>
      <td><button class="btn" style="padding:8px 10px" data-del="${idx}">刪除</button></td>
    `;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll("button[data-del]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const idx = parseInt(b.dataset.del,10);
      const next = loadBudget().filter((_,i)=>i!==idx);
      saveBudget(next);
      renderBudget();
    });
  });
  $("bSum").textContent = `合計：¥${sum.toLocaleString()}　（筆數：${items.length}）`;
}
function exportBudgetCSV(){
  const items = loadBudget();
  const lines = [["date","category","amount_jpy","note"].join(",")];
  items.forEach(it=>{
    const row = [it.date, it.category, it.amount, (it.note||"").replaceAll('"','""')].map(v=>`"${v??""}"`).join(",");
    lines.push(row);
  });
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "budget.csv";
  a.click();
  URL.revokeObjectURL(a.href);
}

/* Toast */
let toastTimer;
function toast(msg){
  clearTimeout(toastTimer);
  let el = document.getElementById("toast");
  if(!el){
    el = document.createElement("div");
    el.id="toast";
    el.style.cssText="position:fixed;left:50%;bottom:96px;transform:translateX(-50%);background:var(--border);color:var(--bg);padding:10px 12px;border-radius:14px;font-size:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:120;opacity:0;transition:opacity .2s;";
    document.body.appendChild(el);
  }
  el.textContent = msg;
  el.style.opacity = "1";
  toastTimer = setTimeout(()=> el.style.opacity="0", 1200);
}

/* Boot */
async function boot(){
  const res = await fetch("./itinerary.json");
  window.APP = await res.json();
  window.STATE = { tab:"itinerary", dayIndex:0 };

  $("appTitle").textContent = window.APP.meta?.title || "旅遊小工具";
  const td = window.APP.meta?.tripDates;
  if(td) $("appSub").textContent = `${td.start} – ${td.end}｜卡片可點詳細｜天氣需連網`;

  mountTabs();
  renderDayStrip();
  renderFlights();
  renderLodging();
  renderEmergency();

  // budget
  const cats = window.APP.budget?.categories || ["交通","餐飲","住宿","門票","購物","其他"];
  const sel = $("bCat");
  sel.innerHTML = cats.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("");
  $("bAdd").addEventListener("click", ()=>{
    const category = sel.value;
    const amount = Number($("bAmt").value || 0);
    const note = $("bNote").value || "";
    if(!amount){ toast("請輸入金額"); return; }
    const date = (new Date()).toISOString().slice(0,10);
    const items = loadBudget();
    items.unshift({date, category, amount, note});
    saveBudget(items);
    $("bAmt").value = "";
    $("bNote").value = "";
    renderBudget();
    toast("已新增");
  });
  $("bExport").addEventListener("click", exportBudgetCSV);
  renderBudget();

  // hash routing
  const h = (location.hash||"").replace("#","").trim();
  if(PANEL_IDS.includes(h)) setTab(h); else setTab("itinerary");

  setActiveDay(0);

  // footer clicks
  document.querySelectorAll(".footerbar a.btn").forEach(a=>{
    a.addEventListener("click", (e)=>{
      e.preventDefault();
      setTab(a.dataset.tab);
    });
  });

  window.addEventListener("hashchange", ()=>{
    const hh = (location.hash||"").replace("#","").trim();
    if(PANEL_IDS.includes(hh)) setTab(hh);
  });
}
boot();
</script>
</body>
</html>
