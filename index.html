<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>名古屋×東京 8 天旅遊小工具</title>
  <meta name="theme-color" content="#ffffff" />
  <style>
    :root{
      --bg:#ffffff; --fg:#111; --muted:#666; --border:#e8e8e8;
      --chip:#f6f6f6; --shadow: 0 6px 24px rgba(0,0,0,.06);
      --danger:#b42318; --warn:#b54708; --ok:#027a48; --info:#175cd3;
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", system-ui, sans-serif;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:var(--sans); background:var(--bg); color:var(--fg); }
    .app{ max-width: 560px; margin:0 auto; padding: 14px 14px 90px; }
    header{
      position: sticky; top:0; background: rgba(255,255,255,.92); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border); z-index:10;
    }
    .topbar{ max-width:560px; margin:0 auto; padding: 12px 14px 10px; }
    .title{ font-size:16px; font-weight:700; letter-spacing:.2px; }
    .subtitle{ margin-top:4px; color:var(--muted); font-size:12px; }
    .tabs{
      display:flex; gap:8px; padding: 10px 14px 12px; overflow:auto;
      border-top:1px solid var(--border);
    }
    .tab{
      padding:8px 12px; border:1px solid var(--border); border-radius:999px;
      font-size:12px; white-space:nowrap; background:#fff;
    }
    .tab.active{ background:var(--fg); color:#fff; border-color:var(--fg); }
    .panel{ display:none; padding-top:14px;}
    .panel.active{ display:block; }

    .daystrip{ display:flex; gap:8px; overflow:auto; padding-bottom:10px; }
    .daybtn{
      min-width:74px; padding:10px 10px; border:1px solid var(--border);
      border-radius:14px; background:#fff;
      text-align:left;
    }
    .daybtn.active{ border-color:var(--fg); box-shadow: var(--shadow); }
    .daybtn .d{ font-weight:700; font-size:12px; }
    .daybtn .dt{ color:var(--muted); font-size:11px; margin-top:2px; }
    .hero{
      border:1px solid var(--border); border-radius: var(--radius);
      padding:12px 12px; box-shadow: var(--shadow);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .hero h2{ margin:0; font-size:14px; }
    .hero .meta{ color:var(--muted); font-size:12px; margin-top:4px; line-height:1.4; }
    .weather{ text-align:right; min-width:120px; }
    .weather .w1{ font-weight:700; font-size:12px; }
    .weather .w2{ color:var(--muted); font-size:11px; margin-top:2px; }
    .cards{ margin-top:12px; display:flex; flex-direction:column; gap:10px; }
    .card{
      border:1px solid var(--border); border-radius: var(--radius);
      padding:12px; box-shadow: var(--shadow);
    }
    .card .row1{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .time{ font-family:var(--mono); font-size:12px; color:var(--muted); }
    .type{
      font-size:11px; padding:4px 8px; border-radius:999px; background:var(--chip); border:1px solid var(--border);
      white-space:nowrap;
    }
    .type.food{ border-color:#ffd7d7; background:#fff5f5; color: var(--danger); }
    .type.spot{ border-color:#dbe7ff; background:#f3f7ff; color: var(--info); }
    .type.transport{ border-color:#e6e6e6; background:#fafafa; color: #333; }
    .type.lodging{ border-color:#d4f8e6; background:#f0fff7; color: var(--ok); }
    .title2{ margin:8px 0 0; font-size:14px; font-weight:700; line-height:1.35; }
    .note{ margin-top:6px; color:var(--muted); font-size:12px; line-height:1.45; }
    .chips{ display:flex; flex-wrap:wrap; gap:6px; margin-top:10px; }
    .chip{
      font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:var(--chip);
    }
    .chip.must{ border-color:#ffb4b4; background:#fff1f1; color:var(--danger); font-weight:700; }
    .chip.buy{ border-color:#d3f8dd; background:#f0fff6; color:var(--ok); font-weight:700; }
    .chip.warn{ border-color:#ffd7a8; background:#fff7ed; color:var(--warn); font-weight:700; }
    .chip.flex{ border-color:#eee; background:#fafafa; color:#555; }
    .actions{ display:flex; gap:8px; margin-top:12px; }
    .btn{
      flex:1; padding:10px 10px; border-radius:12px; border:1px solid var(--border); background:#fff;
      font-size:12px; text-align:center; text-decoration:none; color:var(--fg);
    }
    .btn.primary{ background:var(--fg); color:#fff; border-color:var(--fg); }
    .sectionTitle{ font-size:13px; font-weight:800; margin: 4px 0 10px; }
    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      border:1px solid var(--border); border-radius: var(--radius); padding:12px; box-shadow: var(--shadow);
    }
    .item .h{ font-weight:800; font-size:13px; }
    .item .p{ color:var(--muted); font-size:12px; margin-top:6px; line-height:1.45; }
    .grid2{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media (min-width:480px){ .grid2{ grid-template-columns:1fr 1fr; } }

    /* Budget */
    .budgetForm{ display:flex; gap:8px; flex-wrap:wrap; }
    select,input{ font-family:var(--sans); font-size:12px; padding:10px; border-radius:12px; border:1px solid var(--border); }
    input[type="number"]{ width:120px; }
    input[type="text"]{ flex:1; min-width:160px; }
    .budgetTable{ width:100%; border-collapse:separate; border-spacing:0 8px; margin-top:12px; }
    .budgetTable th{ text-align:left; font-size:11px; color:var(--muted); font-weight:700; }
    .budgetTable td{ background:#fff; border:1px solid var(--border); padding:10px; border-radius:12px; font-size:12px; }
    .footerbar{
      position:fixed; left:0; right:0; bottom:0; background: rgba(255,255,255,.95); backdrop-filter: blur(10px);
      border-top:1px solid var(--border);
    }
    .footerbar .inner{ max-width:560px; margin:0 auto; padding:10px 14px; display:flex; gap:8px; }
    .small{ font-size:11px; color:var(--muted); }
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="title" id="appTitle">名古屋×東京 8 天旅遊小工具</div>
    <div class="subtitle" id="appSub">單頁 App｜可加入主畫面｜天氣需連網</div>
  </div>
  <div class="tabs" id="tabs"></div>
</header>

<div class="app">
  <div class="panel active" id="panel-itinerary">
    <div class="daystrip" id="daystrip"></div>
    <div class="hero" id="dayhero">
      <div>
        <h2 id="dayHeading">Day</h2>
        <div class="meta" id="dayMeta"></div>
      </div>
      <div class="weather">
        <div class="w1" id="w1">天氣載入中</div>
        <div class="w2" id="w2"></div>
      </div>
    </div>
    <div class="cards" id="cards"></div>
  </div>

  <div class="panel" id="panel-flights">
    <div class="sectionTitle">航班資訊</div>
    <div class="list" id="flightsList"></div>
  </div>

  <div class="panel" id="panel-lodging">
    <div class="sectionTitle">住宿資訊</div>
    <div class="list" id="lodgingList"></div>
  </div>

  <div class="panel" id="panel-emergency">
    <div class="sectionTitle">緊急聯絡</div>
    <div class="list" id="emergencyList"></div>
    <div class="small" style="margin-top:10px;">提示：可在 itinerary.json 補上保險/信用卡掛失專線。</div>
  </div>

  <div class="panel" id="panel-budget">
    <div class="sectionTitle">記帳 / 預算</div>
    <div class="item">
      <div class="p">快速新增一筆支出（儲存在本機 localStorage）。</div>
      <div class="budgetForm" style="margin-top:10px;">
        <select id="bCat"></select>
        <input id="bAmt" type="number" inputmode="decimal" placeholder="JPY" />
        <input id="bNote" type="text" placeholder="備註（如：bills hotcakes）" />
        <button class="btn primary" id="bAdd" style="flex:0 0 auto;">新增</button>
      </div>
    </div>
    <div class="item">
      <div class="row1">
        <div class="h">本次紀錄</div>
        <button class="btn" id="bExport" style="flex:0 0 auto;">匯出 CSV</button>
      </div>
      <table class="budgetTable" id="bTable">
        <thead>
          <tr><th>日期</th><th>分類</th><th>金額</th><th>備註</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="small" id="bSum"></div>
    </div>
  </div>
</div>

<div class="footerbar">
  <div class="inner">
    <a class="btn" href="#itinerary" data-tab="itinerary">行程</a>
    <a class="btn" href="#flights" data-tab="flights">航班</a>
    <a class="btn" href="#lodging" data-tab="lodging">住宿</a>
    <a class="btn" href="#emergency" data-tab="emergency">緊急</a>
    <a class="btn" href="#budget" data-tab="budget">預算</a>
  </div>
</div>

<script>
const TYPE_LABEL = { food:"餐廳", spot:"景點/購物", transport:"交通", lodging:"住宿", info:"資訊" };
const PANEL_IDS = ["itinerary","flights","lodging","emergency","budget"];

function $(id){ return document.getElementById(id); }
function esc(s){ return (s??"").toString().replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }

function mapsSearchUrl(q){
  const u = new URL("https://www.google.com/maps/search/");
  u.searchParams.set("api","1");
  u.searchParams.set("query", q);
  return u.toString();
}
function mapsDirUrl(q){
  const u = new URL("https://www.google.com/maps/dir/");
  u.searchParams.set("api","1");
  u.searchParams.set("destination", q);
  return u.toString();
}

function chipHtml(text, kind=""){
  const cls = ["chip"];
  if(kind) cls.push(kind);
  return `<span class="${cls.join(" ")}">${esc(text)}</span>`;
}

function cardTypeClass(t){
  if(t==="food") return "food";
  if(t==="spot") return "spot";
  if(t==="transport") return "transport";
  if(t==="lodging") return "lodging";
  return "";
}

function renderCards(day){
  const container = $("cards");
  container.innerHTML = "";
  day.cards.forEach(c=>{
    // infer lodging
    let t = c.type;
    if((c.tags||[]).includes("住宿")) t = "lodging";
    const addr = c.address || c.title || "";
    const tags = c.tags || [];
    const chips = [];
    tags.forEach(x=>{
      if(x.includes("風險") || x==="偏趕") chips.push(chipHtml(x,"warn"));
      else if(x.includes("必吃") || x.includes("必看") || x==="必拍") chips.push(chipHtml(x,"must"));
      else if(x.includes("必買")) chips.push(chipHtml(x,"buy"));
      else chips.push(chipHtml(x,"flex"));
    });
    (c.mustEat||[]).forEach(x=>chips.push(chipHtml("必吃："+x,"must")));
    (c.mustOrder||[]).forEach(x=>chips.push(chipHtml("必點："+x,"must")));
    (c.mustBuy||[]).forEach(x=>chips.push(chipHtml("必買："+x,"buy")));
    if(c.reservationCode) chips.push(chipHtml("預約："+c.reservationCode,"warn"));

    const html = `
      <div class="card">
        <div class="row1">
          <div class="time">${esc(c.time)}</div>
          <div class="type ${cardTypeClass(t)}">${esc(TYPE_LABEL[t] || "項目")}</div>
        </div>
        <div class="title2">${esc(c.title)}</div>
        ${c.note ? `<div class="note">${esc(c.note)}</div>` : ``}
        ${chips.length ? `<div class="chips">${chips.join("")}</div>` : ``}
        <div class="actions">
          <a class="btn primary" href="${mapsDirUrl(addr)}" target="_blank" rel="noopener">導航</a>
          <a class="btn" href="${mapsSearchUrl(addr)}" target="_blank" rel="noopener">地圖</a>
        </div>
      </div>
    `;
    container.insertAdjacentHTML("beforeend", html);
  });
}

function setActiveDay(idx){
  const day = window.APP.days[idx];
  window.STATE.dayIndex = idx;

  document.querySelectorAll(".daybtn").forEach((b,i)=> b.classList.toggle("active", i===idx));
  $("dayHeading").textContent = `${day.dayTitle}｜${day.date}｜${day.baseLocation}`;
  // lightweight guide hints
  const count = day.cards.length;
  const risk = day.cards.filter(x=>(x.tags||[]).some(t=>t.includes("風險")||t==="偏趕")).length;
  const must = day.cards.filter(x=>(x.tags||[]).some(t=>t.includes("必")) || (x.mustEat||[]).length || (x.mustBuy||[]).length || (x.mustOrder||[]).length).length;
  $("dayMeta").innerHTML = `卡片數：${count}　｜　重點：${must}　｜　風險提示：${risk}<br>提示：排隊即刪、保留 20% 彈性更好玩。`;
  renderCards(day);
  loadWeather(day.baseLocation);
}

async function geocode(place){
  // Open-Meteo Geocoding API (no key)
  const url = new URL("https://geocoding-api.open-meteo.com/v1/search");
  url.searchParams.set("name", place);
  url.searchParams.set("count", "1");
  url.searchParams.set("language", "ja");
  url.searchParams.set("format", "json");
  const r = await fetch(url);
  if(!r.ok) throw new Error("geocode failed");
  const j = await r.json();
  if(!j.results || !j.results.length) throw new Error("no results");
  return j.results[0];
}

async function currentWeather(lat, lon){
  const url = new URL("https://api.open-meteo.com/v1/forecast");
  url.searchParams.set("latitude", lat);
  url.searchParams.set("longitude", lon);
  url.searchParams.set("current", "temperature_2m,weather_code,wind_speed_10m");
  url.searchParams.set("timezone", "auto");
  const r = await fetch(url);
  if(!r.ok) throw new Error("weather failed");
  return await r.json();
}

const WMO = {
  0:"晴",1:"大致晴",2:"局部多雲",3:"多雲",
  45:"霧",48:"霧凍",
  51:"毛毛雨",53:"小雨",55:"中雨",
  61:"小雨",63:"中雨",65:"大雨",
  71:"小雪",73:"中雪",75:"大雪",
  80:"陣雨",81:"強陣雨",82:"暴雨",
  95:"雷雨"
};

let weatherToken = 0;
async function loadWeather(place){
  const myToken = ++weatherToken;
  $("w1").textContent = "天氣載入中";
  $("w2").textContent = place;
  try{
    const g = await geocode(place);
    if(myToken !== weatherToken) return;
    const w = await currentWeather(g.latitude, g.longitude);
    if(myToken !== weatherToken) return;
    const cur = w.current;
    const desc = WMO[cur.weather_code] || ("代碼 " + cur.weather_code);
    $("w1").textContent = `${Math.round(cur.temperature_2m)}°C｜${desc}`;
    $("w2").textContent = `${g.name}｜風 ${Math.round(cur.wind_speed_10m)} km/h`;
  }catch(e){
    if(myToken !== weatherToken) return;
    $("w1").textContent = "天氣無法載入";
    $("w2").textContent = "（需連網）";
  }
}

function renderDayStrip(){
  const strip = $("daystrip");
  strip.innerHTML = "";
  window.APP.days.forEach((d,i)=>{
    const dt = d.date.slice(5);
    const html = `
      <button class="daybtn" data-i="${i}">
        <div class="d">${esc(d.dayTitle)}</div>
        <div class="dt">${esc(dt)} ${esc(d.baseLocation)}</div>
      </button>
    `;
    strip.insertAdjacentHTML("beforeend", html);
  });
  strip.querySelectorAll(".daybtn").forEach(b=>{
    b.addEventListener("click", ()=> setActiveDay(parseInt(b.dataset.i,10)));
  });
}

function renderFlights(){
  const box = $("flightsList");
  box.innerHTML = "";
  window.APP.flights.forEach(f=>{
    const html = `
      <div class="item">
        <div class="h">${esc(f.segment)}｜${esc(f.flightNo)}｜${esc(f.date)}</div>
        <div class="p">${esc(f.from)} → ${esc(f.to)}　${esc(f.dep)} – ${esc(f.arr)}${f.pnr?`<br>PNR：<span style="font-family:var(--mono)">${esc(f.pnr)}</span>`:""}</div>
        <div class="actions">
          <button class="btn" onclick="copyText('${esc(f.flightNo)} ${esc(f.date)} ${esc(f.from)}-${esc(f.to)}');">複製</button>
          <a class="btn primary" href="${mapsSearchUrl(f.from + ' airport')}" target="_blank" rel="noopener">出發機場</a>
        </div>
      </div>
    `;
    box.insertAdjacentHTML("beforeend", html);
  });
}

function renderLodging(){
  const box = $("lodgingList");
  box.innerHTML = "";
  window.APP.lodging.forEach(l=>{
    const html = `
      <div class="item">
        <div class="h">${esc(l.city)}｜${esc(l.name)}</div>
        <div class="p">${esc(l.address)}${l.bookingCode?`<br>訂房代號：<span style="font-family:var(--mono)">${esc(l.bookingCode)}</span>`:""}</div>
        <div class="actions">
          <a class="btn primary" href="${mapsDirUrl(l.address || l.name)}" target="_blank" rel="noopener">導航</a>
          <button class="btn" onclick="copyText('${esc(l.address)}');">複製地址</button>
        </div>
      </div>
    `;
    box.insertAdjacentHTML("beforeend", html);
  });
}

function renderEmergency(){
  const box = $("emergencyList");
  box.innerHTML = "";
  window.APP.emergency.forEach(e=>{
    const html = `
      <div class="item">
        <div class="h">${esc(e.label)}</div>
        <div class="p" style="font-family:${e.value.includes('(')||e.value.includes('+')? 'var(--mono)' : 'var(--sans)'}">${esc(e.value)}</div>
        <div class="actions">
          <button class="btn" onclick="copyText('${esc(e.value)}')">複製</button>
          ${e.value.startsWith('110')||e.value.startsWith('119') ? `<a class="btn primary" href="tel:${e.value.split('（')[0].trim()}">撥打</a>` : `<span style="flex:1"></span>`}
        </div>
      </div>
    `;
    box.insertAdjacentHTML("beforeend", html);
  });
}

function copyText(t){
  navigator.clipboard?.writeText(t).then(()=>toast("已複製")).catch(()=>toast("無法複製"));
}
let toastTimer;
function toast(msg){
  clearTimeout(toastTimer);
  let el = document.getElementById("toast");
  if(!el){
    el = document.createElement("div");
    el.id="toast";
    el.style.cssText="position:fixed;left:50%;bottom:96px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 12px;border-radius:12px;font-size:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:99;opacity:0;transition:opacity .2s;";
    document.body.appendChild(el);
  }
  el.textContent = msg;
  el.style.opacity = "1";
  toastTimer = setTimeout(()=> el.style.opacity="0", 1200);
}

/* Tabs */
function mountTabs(){
  const tabs = $("tabs");
  tabs.innerHTML = "";
  const defs = [
    {id:"itinerary", label:"行程"},
    {id:"flights", label:"航班"},
    {id:"lodging", label:"住宿"},
    {id:"emergency", label:"緊急"},
    {id:"budget", label:"預算"},
  ];
  defs.forEach(d=>{
    const b = document.createElement("button");
    b.className = "tab";
    b.textContent = d.label;
    b.dataset.tab = d.id;
    b.addEventListener("click", ()=> setTab(d.id));
    tabs.appendChild(b);
  });
}

function setTab(tab){
  window.STATE.tab = tab;
  document.querySelectorAll(".tab").forEach(b=> b.classList.toggle("active", b.dataset.tab===tab));
  PANEL_IDS.forEach(id=>{
    const p = document.getElementById("panel-"+id);
    if(p) p.classList.toggle("active", id===tab);
  });
  // sync footer highlight (optional)
  document.querySelectorAll(".footerbar a.btn").forEach(a=>{
    a.style.borderColor = (a.dataset.tab===tab) ? "#111" : "var(--border)";
    a.style.color = (a.dataset.tab===tab) ? "#111" : "#111";
  });
  location.hash = tab;
}

/* Budget (localStorage) */
const BKEY = "nagoya_tokyo_budget_v1";
function loadBudget(){
  try{ return JSON.parse(localStorage.getItem(BKEY) || "[]"); }catch{ return []; }
}
function saveBudget(items){
  localStorage.setItem(BKEY, JSON.stringify(items));
}
function renderBudget(){
  const items = loadBudget();
  const tbody = document.querySelector("#bTable tbody");
  tbody.innerHTML = "";
  let sum = 0;
  items.forEach((it, idx)=>{
    sum += Number(it.amount||0);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${esc(it.date)}</td>
      <td>${esc(it.category)}</td>
      <td style="font-family:var(--mono)">${esc(it.amount)}</td>
      <td>${esc(it.note||"")}</td>
      <td><button class="btn" style="padding:8px 10px" data-del="${idx}">刪除</button></td>
    `;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll("button[data-del]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const idx = parseInt(b.dataset.del,10);
      const next = loadBudget().filter((_,i)=>i!==idx);
      saveBudget(next);
      renderBudget();
    });
  });
  $("bSum").textContent = `合計：¥${sum.toLocaleString()}　（筆數：${items.length}）`;
}

function exportBudgetCSV(){
  const items = loadBudget();
  const lines = [["date","category","amount_jpy","note"].join(",")];
  items.forEach(it=>{
    const row = [it.date, it.category, it.amount, (it.note||"").replaceAll('"','""')].map(v=>`"${v??""}"`).join(",");
    lines.push(row);
  });
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "budget.csv";
  a.click();
  URL.revokeObjectURL(a.href);
}

/* Boot */
async function boot(){
  const res = await fetch("./itinerary.json");
  window.APP = await res.json();
  window.STATE = { tab:"itinerary", dayIndex:0 };

  $("appTitle").textContent = window.APP.meta?.title || "旅遊小工具";
  const td = window.APP.meta?.tripDates;
  if(td) $("appSub").textContent = `${td.start} – ${td.end}｜單頁 App｜可加入主畫面｜天氣需連網`;

  mountTabs();
  renderDayStrip();
  renderFlights();
  renderLodging();
  renderEmergency();

  // budget
  const cats = window.APP.budget?.categories || ["交通","餐飲","住宿","門票","購物","其他"];
  const sel = $("bCat");
  sel.innerHTML = cats.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("");
  $("bAdd").addEventListener("click", ()=>{
    const category = sel.value;
    const amount = Number($("bAmt").value || 0);
    const note = $("bNote").value || "";
    if(!amount){ toast("請輸入金額"); return; }
    const date = (new Date()).toISOString().slice(0,10);
    const items = loadBudget();
    items.unshift({date, category, amount, note});
    saveBudget(items);
    $("bAmt").value = "";
    $("bNote").value = "";
    renderBudget();
    toast("已新增");
  });
  $("bExport").addEventListener("click", exportBudgetCSV);
  renderBudget();

  // hash routing
  const h = (location.hash||"").replace("#","").trim();
  if(PANEL_IDS.includes(h)) setTab(h); else setTab("itinerary");

  setActiveDay(0);

  // footer clicks
  document.querySelectorAll(".footerbar a.btn").forEach(a=>{
    a.addEventListener("click", (e)=>{
      e.preventDefault();
      setTab(a.dataset.tab);
    });
  });

  window.addEventListener("hashchange", ()=>{
    const hh = (location.hash||"").replace("#","").trim();
    if(PANEL_IDS.includes(hh)) setTab(hh);
  });
}
boot();
</script>
</body>
</html>
