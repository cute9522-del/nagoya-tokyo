<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>åå¤å±‹ â†’ æ±äº¬ 8æ—¥æ—…éŠå°å·¥å…·</title>
<style>
:root{
  --bg:#fff7d6;
  --border:#422615;
  --card:rgba(255,255,255,0.48);
  --cardHi:rgba(255,255,255,0.68);
  --radius:14px;
  --bw:1px;

  --text:rgba(38,34,30,0.92);
  --text2:rgba(38,34,30,0.66);
  --muted:rgba(38,34,30,0.48);

  --lineW:3px;
  --shadow: 0 8px 24px rgba(0,0,0,.08);

  /* Sheet */
  --sheetBg: rgba(255,255,255,.88);
  --sheetBorder: rgba(0,0,0,.06);
  --sheetOverlay: rgba(0,0,0,.32);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Hiragino Sans", "Helvetica Neue", Arial;
  background: var(--bg);
  color: var(--text);
}

.header{
  position: sticky;
  top: 0;
  z-index: 20;
  backdrop-filter: blur(10px);
  background: color-mix(in oklab, var(--bg), rgba(255,255,255,.35) 40%);
  border-bottom: 1px solid color-mix(in oklab, var(--border), rgba(255,255,255,.55) 55%);
}
.headerInner{max-width: 860px; margin:0 auto; padding: 14px 14px 12px;}
.hTitle{display:flex; align-items:baseline; gap:10px;}
.hTitle h1{font-size:18px; margin:0;}
.hTitle .sub{font-size:12px; color:var(--muted);}

.tabs{display:flex; gap:8px; margin-top:10px;}
.tab{
  flex:1;
  border:1px solid color-mix(in oklab, var(--border), rgba(255,255,255,.65) 55%);
  background: rgba(255,255,255,.20);
  border-radius:999px;
  padding:10px 12px;
  font-size:13px;
  color: var(--text2);
}
.tab.active{background: rgba(255,255,255,.40); color:var(--text);}

.selector{
  margin-top:10px;
  display:flex;
  gap:8px;
  overflow:auto;
  padding-bottom:2px;
  -webkit-overflow-scrolling: touch;
}
.chip{
  white-space:nowrap;
  border:1px solid color-mix(in oklab, var(--border), rgba(255,255,255,.65) 55%);
  background: rgba(255,255,255,.18);
  border-radius:999px;
  padding: 8px 10px;
  font-size:12px;
  color: var(--text2);
}
.chip.active{background: rgba(255,255,255,.38); color: var(--text);}

.wrap{max-width: 860px; margin:0 auto; padding: 18px 14px 90px;}
.grid{display:grid; gap:10px;}

.card{
  position:relative;
  background: var(--card);
  border: var(--bw) solid color-mix(in oklab, var(--border), rgba(255,255,255,.65) 55%);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 12px 12px 12px calc(12px + var(--lineW));
  overflow:hidden;
}
.card::before{
  content:"";
  position:absolute;
  left:0; top:0; bottom:0;
  width: var(--lineW);
  background: var(--typeLine, rgba(120,120,120,.35));
}
.card.highlight{background: var(--cardHi);}

.row{display:flex; align-items:flex-start; justify-content:space-between; gap:12px;}
.time{min-width:58px; font-size:12px; color: var(--muted);}
.title2{font-size:15px; margin:0; line-height:1.25;}
.meta{margin-top:6px; display:flex; flex-wrap:wrap; gap:6px;}
.tag{font-size:11px; padding:4px 8px; border-radius:999px; background: rgba(255,255,255,.26); border:1px solid rgba(0,0,0,.05); color: var(--text2);}
.tag.strong{font-weight:650; color: var(--text); background: rgba(255,255,255,.38);}

.actions{display:flex; gap:8px; margin-top:10px;}
.btn{flex:1; border:1px solid color-mix(in oklab, var(--border), rgba(255,255,255,.70) 60%);
  background: rgba(255,255,255,.25); border-radius:10px; padding:10px 10px; font-size:13px; color: var(--text);
  text-align:center; text-decoration:none;
}
.btn.secondary{color: var(--text2);}
.small{font-size:12px; color: var(--text2); line-height:1.5; margin-top:8px;}

.footerBar{position:fixed; left:0; right:0; bottom:0; padding:10px 14px 16px;
  background: color-mix(in oklab, var(--bg), rgba(255,255,255,.40) 40%);
  border-top: 1px solid color-mix(in oklab, var(--border), rgba(255,255,255,.65) 55%);
  backdrop-filter: blur(10px);
}
.footerInner{max-width:860px; margin:0 auto; display:flex; gap:10px;}
.search{flex:1; border-radius:12px; border:1px solid color-mix(in oklab, var(--border), rgba(255,255,255,.65) 55%);
  background: rgba(255,255,255,.26); padding:12px 12px; font-size:14px; outline:none; color: var(--text);
}
.pillBtn{border-radius:12px; border:1px solid color-mix(in oklab, var(--border), rgba(255,255,255,.65) 55%);
  background: rgba(255,255,255,.26); padding:12px 12px; font-size:14px;
}

/* Modal / iOS-like bottom sheet */
.modalBg{
  position:fixed; inset:0;
  background: var(--sheetOverlay);
  display:none;
  align-items:flex-end;
  justify-content:center;
  z-index:50;
}
.modalBg.show{display:flex;}

.sheet{
  width:min(860px, 100%);
  border-radius:18px 18px 0 0;
  background: var(--sheetBg);
  border: 1px solid var(--sheetBorder);
  box-shadow: 0 -12px 40px rgba(0,0,0,.18);
  max-height: 82vh;
  overflow:hidden;
  transform: translateY(0px);
  transition: transform .18s ease;
}

.sheetHeader{
  position:relative;
  padding: 10px 14px 10px calc(14px + 6px);
  border-bottom: 1px solid rgba(0,0,0,.05);
}
.sheetHeader::before{
  content:"";
  position:absolute;
  left:0; top:0; bottom:0;
  width: 6px;
  background: var(--accent, rgba(120,120,120,.35));
}

.grabberWrap{display:flex; justify-content:center; padding-top: 6px; padding-bottom: 4px;}
.grabber{ width: 48px; height: 5px; border-radius: 999px; background: rgba(0,0,0,.18); }

.sheetTitleRow{display:flex; align-items:flex-start; justify-content:space-between; gap:10px;}
.sheetTitle{margin: 0; font-size: 16px; line-height: 1.2;}
.sheetSub{color: var(--muted); font-size: 12px; margin-top: 2px;}

.mustBadges{display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;}
.badge{ font-size: 11px; padding: 5px 8px; border-radius: 999px; background: rgba(255,255,255,.42);
  border: 1px solid rgba(0,0,0,.06); color: var(--text2); display:inline-flex; align-items:center; gap: 5px; }
.badge strong{color: var(--text);}

.sheetBody{ padding: 12px 14px 6px; max-height: calc(82vh - 150px); overflow:auto; -webkit-overflow-scrolling: touch; }
.block{margin-top: 10px; font-size: 13px; color: var(--text2); line-height: 1.55;}

.sheetBottom{ position: sticky; bottom: 0; padding: 10px 14px 14px; border-top: 1px solid rgba(0,0,0,.05);
  background: color-mix(in oklab, var(--sheetBg), rgba(255,255,255,.50) 40%);
  backdrop-filter: blur(10px);
}
.sheetActions{display:flex; gap: 8px; flex-wrap:wrap;}
.sheetActions .btn{flex: 1 1 120px;}
</style>
</head>
<body>
  <div class="header">
    <div class="headerInner">
      <div class="hTitle">
        <h1 id="appTitle">åå¤å±‹ â†’ æ±äº¬ 8æ—¥æ—…éŠå°å·¥å…·</h1>
        <div class="sub">2025-12-20 â€” 2025-12-27</div>
      </div>
      <div class="tabs" id="tabs"></div>
      <div class="selector" id="selector"></div>
    </div>
  </div>

  <div class="wrap"><div id="view"></div></div>

  <div class="footerBar">
    <div class="footerInner">
      <input id="q" class="search" placeholder="æœå°‹ï¼ˆä¾‹ï¼šè“¬èŠè»’ã€å‰åœåŠ›ã€æ–°å¹¹ç·šï¼‰" />
      <button id="topBtn" class="pillBtn" title="å›åˆ°é ‚éƒ¨">â†‘</button>
    </div>
  </div>

  <div class="modalBg" id="modalBg" role="dialog" aria-modal="true">
    <div class="sheet" id="sheet"></div>
  </div>

<script>
const TYPE_COLORS = {"flight": "rgba(196,116,116,0.55)", "train": "rgba(108,133,155,0.55)", "bus": "rgba(146,124,102,0.55)", "metro": "rgba(120,120,120,0.45)", "walk": "rgba(120,120,120,0.33)", "hotel": "rgba(132,116,156,0.55)", "food": "rgba(186,140,98,0.55)", "cafe": "rgba(170,140,122,0.50)", "spot": "rgba(126,152,126,0.50)", "shopping": "rgba(162,128,150,0.48)", "view": "rgba(140,150,176,0.48)", "area": "rgba(140,140,140,0.38)"};
let DATA = null;
let ACTIVE_TAB = "itinerary";
let ACTIVE_DAY = 1;
let ACTIVE_ESS = "flights";
let QUERY = "";

/* swipe-to-close state */
let dragStartY = 0;
let dragCurrentY = 0;
let dragging = false;

function el(html) { const t=document.createElement("template"); t.innerHTML=html.trim(); return t.content.firstElementChild; }
function safe(s) { return (s ?? "").toString(); }
function makeGoogleMapsNav(name) { const q=encodeURIComponent(name); return `https://www.google.com/maps/search/?api=1&query=${q}`; }
function makeSearchOfficial(name) { const q=encodeURIComponent(name + " å…¬å¼ã‚µã‚¤ãƒˆ"); return `https://www.google.com/search?q=${q}`; }
function typeLineColor(type) { return TYPE_COLORS[type] || "rgba(120,120,120,.35)"; }

function renderTabs() {
  const tabs=document.getElementById("tabs");
  tabs.innerHTML="";
  (DATA.tabs||[]).forEach(t=>{
    const b=el(`<button class="tab ${t.id===ACTIVE_TAB?'active':''}">${t.label}</button>`);
    b.onclick=()=>{ ACTIVE_TAB=t.id; render(); window.scrollTo({top:0, behavior:"smooth"}); };
    tabs.appendChild(b);
  });
}

function renderSelector() {
  const sel=document.getElementById("selector");
  sel.innerHTML="";
  if (ACTIVE_TAB==="itinerary") {
    (DATA.days||[]).forEach(d=>{
      const c=el(`<button class="chip ${d.day===ACTIVE_DAY?'active':''}">Day ${d.day}</button>`);
      c.onclick=()=>{ ACTIVE_DAY=d.day; render(); window.scrollTo({top:0, behavior:"smooth"}); };
      sel.appendChild(c);
    });
  } else if (ACTIVE_TAB==="essentials") {
    [["flights","èˆªç­"],["lodgings","ä½å®¿"],["emergency","ç·Šæ€¥"],["budget","é ç®—"]].forEach(([id,label])=>{
      const c=el(`<button class="chip ${id===ACTIVE_ESS?'active':''}">${label}</button>`);
      c.onclick=()=>{ ACTIVE_ESS=id; render(); window.scrollTo({top:0, behavior:"smooth"}); };
      sel.appendChild(c);
    });
  } else {
    sel.appendChild(el(`<div style="height:2px"></div>`));
  }
}

function tagHtml(tags) {
  return (tags||[]).map(x=>{
    const strong = (x.includes("å¿…") || x.includes("éœ€") || x.includes("æŒ‡å®š") || x.includes("é ç´„"));
    return `<span class="tag ${strong?'strong':''}">${x}</span>`;
  }).join("");
}

function cardHtml(item) {
  const t=item.type||"spot";
  const isHi=!!item.highlight;
  const name=safe(item.name);
  const time=safe(item.time);
  const detail=safe(item.detail);
  const official = (item.links||[]).find(l => (l.label||"").includes("å®˜æ–¹"));
  const officialUrl = official?.url || item.officialLink || "";
  const navUrl = makeGoogleMapsNav(name);
  const fallbackOfficial = makeSearchOfficial(name);

  return `
  <div class="card ${isHi?'highlight':''}" style="--typeLine:${typeLineColor(t)}">
    <div class="row">
      <div class="time">${time}</div>
      <div style="flex:1">
        <div class="title2">${name}</div>
        <div class="meta">${tagHtml(item.tags)}</div>
      </div>
      <div><button class="btn secondary" style="padding:8px 10px; font-size:12px" data-open="1">è©³ç´°</button></div>
    </div>
    <div class="actions">
      <a class="btn" href="${navUrl}" target="_blank" rel="noreferrer">å°èˆª</a>
      ${officialUrl ? `<a class="btn secondary" href="${officialUrl}" target="_blank" rel="noreferrer">å®˜æ–¹</a>` : `<a class="btn secondary" href="${fallbackOfficial}" target="_blank" rel="noreferrer">æœå°‹å®˜ç¶²</a>`}
    </div>
    ${detail ? `<div class="small">${detail}</div>` : ""}
  </div>`;
}

function buildMustBadges(tags, type) {
  const t = (tags||[]).join(" ");
  const badges = [];
  if (t.includes("å¿…åƒ")) badges.push({label:"å¿…åƒ", icon:"ğŸ´"});
  if (t.includes("å¿…çœ‹") || t.includes("å¿…ç©") || t.includes("å¿…é€›")) badges.push({label:"å¿…çœ‹", icon:"ğŸ‘€"});
  if (t.includes("å¿…è²·")) badges.push({label:"å¿…è²·", icon:"ğŸ›ï¸"});
  if (t.includes("éœ€é ç´„") || t.includes("é ç´„") || t.includes("æŒ‡å®šå¸­")) badges.push({label:"éœ€ç¢ºèª", icon:"â±ï¸"});
  if (badges.length===0) {
    const map={food:"é¤é£²", cafe:"å’–å•¡", spot:"æ™¯é»", shopping:"è³¼ç‰©", train:"äº¤é€š", flight:"èˆªç­", hotel:"ä½å®¿", metro:"äº¤é€š", bus:"äº¤é€š", area:"å€åŸŸ", view:"æ™¯è§€"};
    badges.push({label: map[type] || "è³‡è¨Š", icon:"â€¢"});
  }
  return badges;
}

function pickAccent(tags, type) {
  const t = (tags||[]).join(" ");
  if (t.includes("å¿…åƒ")) return typeLineColor("food");
  if (t.includes("å¿…çœ‹") || t.includes("å¿…ç©") || t.includes("å¿…é€›")) return typeLineColor("spot");
  if (t.includes("å¿…è²·")) return typeLineColor("shopping");
  return typeLineColor(type);
}

function openSheet(opts) {
  const bg=document.getElementById("modalBg");
  const sheet=document.getElementById("sheet");

  const title = opts.title || "";
  const subtitle = opts.subtitle || "";
  const blocks = opts.blocks || [];
  const links = opts.links || [];
  const tags = opts.tags || [];
  const type = opts.type || "spot";
  const accent = opts.accent || pickAccent(tags, type);

  const badges = buildMustBadges(tags, type);
  const badgesHtml = badges.map(b => `<span class="badge"><span>${b.icon}</span><strong>${b.label}</strong></span>`).join("");

  const blocksHtml = blocks.map(b => `<div class="block">${b}</div>`).join("");
  const linksHtml = links.map(l => `<a class="btn ${(l.primary?'':'secondary')}" href="${l.url}" target="_blank" rel="noreferrer">${l.label}</a>`).join("");

  sheet.style.setProperty("--accent", accent);
  sheet.innerHTML = `
    <div class="grabberWrap" data-grab="1"><div class="grabber"></div></div>
    <div class="sheetHeader" data-grab="1">
      <div class="sheetTitleRow">
        <div>
          <div class="sheetSub">${subtitle}</div>
          <h2 class="sheetTitle">${title}</h2>
        </div>
        <div class="mustBadges">${badgesHtml}</div>
      </div>
    </div>
    <div class="sheetBody" id="sheetBody">
      ${blocksHtml}
    </div>
    <div class="sheetBottom">
      <div class="sheetActions">
        ${linksHtml}
        <button class="btn secondary" id="closeBtn" type="button">é—œé–‰</button>
      </div>
    </div>
  `;

  bg.classList.add("show");
  document.getElementById("closeBtn").onclick=closeSheet;
  bg.onclick=(e)=>{ if(e.target===bg) closeSheet(); };

  const grabAreas = sheet.querySelectorAll('[data-grab="1"]');
  grabAreas.forEach(a => {
    a.addEventListener("touchstart", onTouchStart, {passive:true});
    a.addEventListener("touchmove", onTouchMove, {passive:false});
    a.addEventListener("touchend", onTouchEnd, {passive:true});
  });
}

function closeSheet(){ 
  const bg=document.getElementById("modalBg");
  const sheet=document.getElementById("sheet");
  sheet.style.transform = "translateY(0px)";
  bg.classList.remove("show");
}

function onTouchStart(e) {
  dragging = true;
  dragStartY = e.touches[0].clientY;
  dragCurrentY = dragStartY;
}
function onTouchMove(e) {
  if (!dragging) return;
  dragCurrentY = e.touches[0].clientY;
  const dy = Math.max(0, dragCurrentY - dragStartY);
  if (dy > 0) e.preventDefault();
  const sheet = document.getElementById("sheet");
  sheet.style.transform = `translateY(${dy}px)`;
}
function onTouchEnd() {
  if (!dragging) return;
  dragging = false;
  const dy = Math.max(0, dragCurrentY - dragStartY);
  const sheet = document.getElementById("sheet");
  if (dy > 90) closeSheet();
  else sheet.style.transform = "translateY(0px)";
}

function matchQuery(s){ if(!QUERY) return true; const q=QUERY.toLowerCase(); return (s||"").toLowerCase().includes(q); }

function renderItinerary() {
  const view=document.getElementById("view");
  view.innerHTML="";
  const day = (DATA.days||[]).find(d=>d.day===ACTIVE_DAY);
  if(!day) return;

  const list=(day.spots||[]).filter(x=> !QUERY || matchQuery(x.name) || matchQuery((x.tags||[]).join(" ")) || matchQuery(x.detail||""));
  const head=el(`<div class="card" style="--typeLine: rgba(120,120,120,.25)">
    <div class="title2">Day ${day.day} Â· ${day.date}</div>
    <div class="small">${day.title}<br><span style="color:var(--muted)">${day.city||""}</span></div>
  </div>`);
  view.appendChild(head);
  view.appendChild(el('<div style="height:10px"></div>'));

  const grid=el(`<div class="grid"></div>`);
  list.forEach(item=>{
    const node=el(cardHtml(item));
    node.querySelector('[data-open="1"]').onclick=()=>{
      const blocks=[];
      if(item.detail) blocks.push(item.detail);
      if(item.transportRef) {
        const tr=(DATA.transports||[]).find(x=>x.id===item.transportRef);
        if(tr) {
          blocks.push(`<b>äº¤é€šè³‡è¨Š</b>`);
          if(tr.route) blocks.push(`è·¯ç·šï¼š${tr.route}`);
          if(tr.departureDate) blocks.push(`æ—¥æœŸï¼š${tr.departureDate}`);
          if(tr.from && tr.to) blocks.push(`æ™‚é–“ï¼š${tr.from.time} â†’ ${tr.to.time}`);
          if(tr.train) {
            blocks.push(`è»Šæ¬¡ï¼š${tr.train.name}ï¼ˆ${tr.train.series} / ${tr.train.cars} ä¸¡ / ${tr.train.class}ï¼‰`);
            if(tr.train.seats?.length) blocks.push(`åº§ä½ï¼š${tr.train.seats.join(", ")}`);
          }
          if(tr.notes?.length) blocks.push(`<b>æé†’</b><br>${tr.notes.map(n=>"â€¢ "+n).join("<br>")}`);
        }
      }
      if(item.tags?.length) blocks.push(`<b>æ¨™ç±¤</b><br>${item.tags.map(x=>"â€¢ "+x).join("<br>")}`);

      const links=[];
      (item.links||[]).forEach(l=>links.push({label:l.label, url:l.url, primary:false}));
      if(item.officialLink) links.push({label:"å®˜æ–¹", url:item.officialLink, primary:false});
      links.push({label:"å°èˆª", url: makeGoogleMapsNav(item.name), primary:true});
      if(!links.some(l=>(l.label||"").includes("å®˜æ–¹"))) links.push({label:"æœå°‹å®˜ç¶²", url: makeSearchOfficial(item.name), primary:false});

      openSheet({
        title: item.name,
        subtitle: `${day.date} Â· Day ${day.day}`,
        blocks,
        links,
        tags: item.tags || [],
        type: item.type || "spot",
        accent: pickAccent(item.tags||[], item.type||"spot")
      });
    };
    grid.appendChild(node);
  });
  view.appendChild(grid);
}

function renderTransport() {
  const view=document.getElementById("view");
  view.innerHTML="";
  const list=(DATA.transports||[]).filter(t => !QUERY || matchQuery(t.title) || matchQuery(t.route||"") || matchQuery(JSON.stringify(t)));
  if(list.length===0) {
    view.appendChild(el(`<div class="card" style="--typeLine: rgba(120,120,120,.25)"><div class="title2">æ‰¾ä¸åˆ°äº¤é€šè³‡è¨Š</div></div>`));
    return;
  }
  const grid=el(`<div class="grid"></div>`);
  list.forEach(tr=>{
    const blocks=[];
    if(tr.route) blocks.push(`è·¯ç·šï¼š${tr.route}`);
    if(tr.departureDate) blocks.push(`æ—¥æœŸï¼š${tr.departureDate}`);
    if(tr.from && tr.to) blocks.push(`æ™‚é–“ï¼š${tr.from.name} ${tr.from.time} â†’ ${tr.to.name} ${tr.to.time}`);
    if(tr.train) {
      blocks.push(`è»Šæ¬¡ï¼š${tr.train.name}ï¼ˆ${tr.train.series} / ${tr.train.cars} ä¸¡ / ${tr.train.class}ï¼‰`);
      if(tr.train.seats?.length) blocks.push(`åº§ä½ï¼š${tr.train.seats.join(", ")}`);
    }
    if(tr.notes?.length) blocks.push(`æé†’ï¼š<br>${tr.notes.map(n=>"â€¢ "+n).join("<br>")}`);

    const node=el(`<div class="card" style="--typeLine:${typeLineColor(tr.mode)}">
      <div class="row">
        <div class="time">${(tr.mode||"").toUpperCase()}</div>
        <div style="flex:1">
          <div class="title2">${tr.title}</div>
          <div class="small">${blocks.join("<br>")}</div>
        </div>
        <div><button class="btn secondary" style="padding:8px 10px; font-size:12px" data-open="1">è©³ç´°</button></div>
      </div>
    </div>`);
    node.querySelector('[data-open="1"]').onclick=()=>openSheet({
      title: tr.title,
      subtitle: tr.operator || "äº¤é€š",
      blocks,
      links: (tr.links||[]).map(l=>({label:l.label, url:l.url, primary:true})),
      tags: ["äº¤é€š"],
      type: tr.mode || "train",
      accent: typeLineColor(tr.mode || "train")
    });
    grid.appendChild(node);
  });
  view.appendChild(grid);
}

function renderEssentials() {
  const view=document.getElementById("view");
  view.innerHTML="";
  const e=DATA.essentials||{};
  const grid=el(`<div class="grid"></div>`);

  const addCard = (type, title, bodyHtml) => {
    const node=el(`<div class="card" style="--typeLine:${typeLineColor(type)}">
      <div class="title2">${title}</div>
      <div class="small">${bodyHtml}</div>
      <div class="actions"><button class="btn secondary" data-open="1">è©³ç´°</button></div>
    </div>`);
    node.querySelector('[data-open="1"]').onclick=()=>openSheet({
      title,
      subtitle: "èˆªç­/ä½å®¿",
      blocks: [bodyHtml],
      links: [],
      tags: [title],
      type,
      accent: typeLineColor(type)
    });
    grid.appendChild(node);
  };

  if (ACTIVE_ESS==="flights") {
    const rows=(e.flights||[]).map(f=>`â€¢ ${f.direction}ï¼š${f.date} <b>${f.flightNo}</b>ï¼ˆ${f.from} â†’ ${f.to}ï¼‰`).join("<br>") || "ï¼ˆæœªå¡«ï¼‰";
    addCard("flight","èˆªç­è³‡è¨Š", rows);
  } else if (ACTIVE_ESS==="lodgings") {
    const rows=(e.lodgings||[]).map(l=>`â€¢ ${l.city}ï¼š<b>${l.name}</b><br><span style="color:var(--muted)">${l.address}</span>`).join("<br><br>") || "ï¼ˆæœªå¡«ï¼‰";
    addCard("hotel","ä½å®¿è³‡è¨Š", rows);
  } else if (ACTIVE_ESS==="emergency") {
    const rows=(e.emergency||[]).map(x=>`â€¢ ${x.label}ï¼š<b>${x.value}</b>`).join("<br>") || "ï¼ˆæœªå¡«ï¼‰";
    addCard("metro","ç·Šæ€¥è¯çµ¡", rows);
  } else {
    const b=e.budgetTemplate||{};
    const rows = `å¹£åˆ¥ï¼š${b.currencyBase||"JPY"}<br>åˆ†é¡ï¼š${(b.categories||[]).join("ã€")}<br><br>å»ºè­°ï¼šæ¯å¤©ç¡å‰ 3 åˆ†é˜ï¼Œå…ˆæŠŠã€Œäº¤é€š/é¤é£²/é–€ç¥¨/è³¼ç‰©ã€å››é¡è¨˜å®Œå³å¯ã€‚`;
    addCard("metro","è¨˜å¸³ï¼é ç®—è¡¨ï¼ˆæ¨¡æ¿ï¼‰", rows);
  }

  view.appendChild(grid);
}

function render() {
  renderTabs();
  renderSelector();
  if (ACTIVE_TAB==="itinerary") renderItinerary();
  else if (ACTIVE_TAB==="transport") renderTransport();
  else renderEssentials();
}

async function load() {
  const res=await fetch("./itinerary.json", {cache:"no-store"});
  DATA=await res.json();
  document.getElementById("appTitle").textContent = DATA.meta?.appTitle || "Trip";
  render();
}

document.getElementById("q").addEventListener("input", e=>{ QUERY=e.target.value.trim(); render(); });
document.getElementById("topBtn").onclick = ()=>window.scrollTo({top:0, behavior:"smooth"});

load().catch(err=>{
  document.getElementById("view").innerHTML = `<div class="card" style="--typeLine: rgba(120,120,120,.25)">
    <div class="title2">è³‡æ–™è¼‰å…¥å¤±æ•—</div>
    <div class="small">è«‹ç¢ºèª itinerary.json èˆ‡ index.html åœ¨åŒä¸€å±¤ã€‚<br><span style="color:var(--muted)">${String(err)}</span></div>
  </div>`;
});
</script>
</body>
</html>
